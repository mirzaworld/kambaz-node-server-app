import UsersDao from './dao.js';

export default function UsersRoutes(app, db) {
  const dao = UsersDao(db);

  const createUser = (req, res) => {
    const user = req.body;
    const created = dao.createUser(user);
    res.json(created);
  };

  const findAllUsers = (req, res) => {
    res.json(dao.findAllUsers());
  };

  const findUserById = (req, res) => {
    const user = dao.findUserById(req.params.userId);
    if (!user) return res.status(404).json({ message: 'User not found' });
    res.json(user);
  };

  const updateUser = (req, res) => {
    const updated = dao.updateUser(req.params.userId, req.body);
    if (!updated) return res.status(404).json({ message: 'Unable to update user' });
    req.session['currentUser'] = updated;
    res.json(updated);
  };

  const deleteUser = (req, res) => {
    const ok = dao.deleteUser(req.params.userId);
    if (!ok) return res.status(404).json({ message: 'Unable to delete user' });
    res.sendStatus(200);
  };

  const signup = (req, res) => {
    const user = req.body;
    const existing = dao.findUserByUsername(user.username);
    if (existing) return res.status(400).json({ message: 'Username already exists' });
    const created = dao.createUser(user);
    req.session['currentUser'] = created;
    res.json(created);
  };

  const signin = (req, res) => {
    const { username, password } = req.body;
    const user = dao.findUserByCredentials(username, password);
    if (!user) return res.status(401).json({ message: 'Invalid credentials' });
    req.session['currentUser'] = user;
    res.json(user);
  };

  const signout = (req, res) => {
    req.session.destroy(() => {
      res.sendStatus(200);
    });
  };

  const profile = (req, res) => {
    const user = req.session['currentUser'] || null;
    if (!user) return res.sendStatus(401);
    res.json(user);
  };

  app.post('/api/users', createUser);
  app.get('/api/users', findAllUsers);
  app.get('/api/users/:userId', findUserById);
  app.put('/api/users/:userId', updateUser);
  app.delete('/api/users/:userId', deleteUser);
  app.post('/api/users/signup', signup);
  app.post('/api/users/signin', signin);
  app.post('/api/users/signout', signout);
  app.post('/api/users/profile', profile);
}
